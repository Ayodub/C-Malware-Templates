#include <Windows.h>
#include <stdlib.h>
#include <string.h>
#include <stdio.h>

// This holds the state of the RC4 algorithm with two unsigned integers and an array of 256 unsigned characters
typedef struct {
    unsigned int i;
    unsigned int j;
    unsigned char s[256];
} Rc4Context;

//Prototypes for the rc4 initialisation, and rc4 encryption/decryption ciphers.
void rc4Init(Rc4Context* context, const unsigned char* key, size_t length);
void rc4Cipher(Rc4Context* context, const unsigned char* input, unsigned char* output, size_t length);

//Contains the data to be encrypted
unsigned char shellcode[] = {
    "Place payload here"
};

//The secret key to be used for encryption. We can represent this key in several ways
// Method 1 plaintext: unsigned char* key = "secretkey";
// Method 2 hex bytes: unsigned char key[] = { 0x6D, 0x61, 0x6C, 0x64, 0x65, 0x76};
// Method 3  Hex/string escape sequence: unsigned char* key = "\x6D\x61\x6C\x64\x65\x76\x31\x32\x33";
// Method 4 (better) array of chars: unsigned char key[] = { 's', 'e', 'c', 'r', 'e', 't', 'k', 'e', 'y'};

// Using Method 2 hex bytes array
unsigned char key[] = {
    0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F
};

int main() {

    //calling the Rc4Context struct and giving it an alaias of ctx and initialising to zero
    Rc4Context ctx = { 0 };

    //initialising the rc4 context with the provided key
    rc4Init(&ctx, key, sizeof(key));

    //allocating memory to variable cipher text. The size of memory allocated is set to the size of the given shellcode
    unsigned char* Ciphertext = (unsigned char*)malloc(strlen(shellcode) * sizeof(int));
    //zeroing out the memory space
    ZeroMemory(Ciphertext, strlen(shellcode) * sizeof(int));
    //Calling the rc4cipher prototype to encrypt the shellcode data and storing the result in a ciphertext array.
    rc4Cipher(&ctx, shellcode, Ciphertext, strlen(shellcode));

    //print the cipher text to console. In a functional payload this would be removed and is simply for debugging
    printf("[i] Ciphertext : 0x%p \n", Ciphertext);

    free(Ciphertext);
    return 0;
}

