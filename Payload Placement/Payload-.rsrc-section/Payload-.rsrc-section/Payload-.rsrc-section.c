#include <Windows.h>
#include <stdio.h>
#include "resource.h"

/* Placing in.rsrc section is a cleaner method to store payloads,
due to the size constraints in .data and .rdata */

/* This requires importing a resource file, in repository's case, the calc.ico
file, which has the calc.exe payload embedded in it */

/* in order for our c program to access the stored payload in the .ico file,
we need to use several Windows APIs*/

int main() {

	HRSRC	hRsrc = NULL;
	HGLOBAL	hGlobal = NULL;
	PVOID	pPayloadAddress = NULL;
	SIZE_T	sPayloadSize = NULL;



	//FindResourceW Windows API gets the location of data stored in a resource file
	// We are finding the location of the data stored in .rsrc by its id "IDR_RCDATA1"
	hRsrc = FindResourceW(NULL, MAKEINTRESOURCEW(IDR_RCDATA1), RT_RCDATA);
	if (hRsrc == NULL) {
		// in case of failure
		printf("[!] FindResourceW Failed With Error: %d \n", GetLastError());
		return -1;
	}



	/*Get HGLOBAL, the handle of the specified resource data.This is required to call
	LockResource, which is used later */

	hGlobal = LoadResource(NULL, hRsrc);
	if (hGlobal == NULL) {
		//in case of failure
		printf("[!] LoadResource Failed With Error : %d \n", GetLastError());
		return -1;
	}

	// Get the address of our payload in .rsrc section
	pPayloadAddress = LockResource(hGlobal);
	if (pPayloadAddress == NULL) {
		// in case of failure
		printf("[!] LockResource Failed with Error: %d \n", GetLastError());
		return -1;
	}

		// Get the size of our payload in .rsrc section
	sPayloadSize = SizeofResource(NULL, hRsrc);
	if (sPayloadSize == NULL) {
		//in case of failure
		printf("[!] SizeofResource Failed with Error : %d \n", GetLastError());
		return -1;
	}

	//print pointer and size to the screen:

	printf("[i] sPayloadAddress var : 0x%p \n", pPayloadAddress);
	printf("[i] sPayloadSize var : %ld \n", sPayloadSize);
	printf("[#] Press <Enter> To Continue ...");
	getchar();

	/* ----------- Updating the .rsrc payload -----------*/
	/* We can't edit the payload from directly within the resource section.
	Therefore, if we want to modify it, it must be moved to a temporary buffer*/

	// Example:
	
	//Allocate some memory using HeapAlloc:

	PVOID pTemporaryBuffer = HeapAlloc(GetProcessHeap(), 0, sPayloadSize);

	//copy the payload from resource section to the buffer

	if (pTemporaryBuffer != NULL){
		memcpy(pTemporaryBuffer, pPayloadAddress, sPayloadSize);
	}
	
	//We can print the base address of our buffer (pTemporaryBuffer)
	printf("[i] pTemporaryBuffer var : 0x%p \n", pTemporaryBuffer);
	printf("[i] The temporary buffer now holds the payload in a region we can modify");
	printf("[#] Press <Enter> To Continue ...");
	getchar();
	
	/* Since pTemporaryBuffer now points to a writable memory region which is
	 holding the payload, it's possible for us to decrypt it and perform updates */



	return 0;
	
};